<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>

<h1>상품 목록</h1>
<table>
    <tr>
        <th>id</th>
        <th>name</th>
        <th>price</th>
        <th>rating</th>
        <th>reviewCount</th>
        <th>thumbnail</th>
        <th>delete</th>
    </tr>
    <tr th:each="product: ${products}">
        <td th:text="${product.id}"></td>
        <td>
            <a th:href="'/products/manage/' + ${product.id}"
               th:text="${product.name}">
            </a>
        </td>
        <td th:text="${product.price}"></td>
        <td th:text="${product.rating}"></td>
        <td th:text="${product.reviewCount}"></td>
        <td>
            <span th:if="!${product.thumbnailImageUrl}">상품 이미지 없음</span>
            <img th:if="${product.thumbnailImageUrl}"
                 th:src="${product.thumbnailImageUrl}" alt="productImage"/>
        </td>
        <td>
            <button th:onclick="'deleteHandle(' + ${product.id} + ')'">Delete</button>
        </td>
    </tr>
</table>

<div>
    <label for="keyword"></label>
    <input type="text" id="keyword" />
    <button onclick="search()">검색</button>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-center"
     th:if="${products.totalPages > products.pageable.pageNumber}"
     th:object="${products.pageable}"
     th:with="pageLine = 10,
              pageNumber = *{pageNumber},
              pageSize = *{pageSize},
              totalPages = ${products.totalPages},
              startPage = ${(pageNumber / pageLine) * pageLine + 1},
              endPage = (${(totalPages == 0) ? 1 : (startPage + (pageLine - 1) < totalPages ? startPage + (pageLine - 1) : totalPages)})">
    <ul class="pagination">

        <li th:classappend="${startPage <= 1} ? 'disabled'" class="page-item">
            <button class="page-link" aria-label="Previous"
                    th:onclick="'paging(' + ${pageNumber - pageLine} + ')'">
                <span>&laquo;</span>
                <span class="sr-only">10 Previous</span>
            </button>
        </li>

        <li th:classappend="${!products.hasPrevious()} ? 'disabled'" class="page-item">
            <button class="page-link" aria-label="Previous"
                    th:onclick="'paging(' + ${pageNumber - 1} + ')'">
                <span aria-hidden="true">&lt;</span>
                <span class="sr-only">Previous</span>
            </button>
        </li>

        <li th:each="page: ${#numbers.sequence(startPage, endPage)}" th:classappend="${page - 1 == pageNumber} ? 'active'" class="page-item">
            <button th:text="${page}" class="page-link"
                    th:onclick="'paging(' + ${page - 1} + ')'"></button>
        </li>

        <li th:classappend="${!products.hasNext()} ? 'disabled'" class="page-item">
            <button class="page-link" aria-label="Next"
                    th:onclick="'paging(' + ${pageNumber + 1} + ')'">
                <span aria-hidden="true">&gt;</span>
                <span class="sr-only">Next</span>
            </button>
        </li>

        <li th:classappend="${endPage >= totalPages} ? 'disabled'" class="page-item">
            <button class="page-link" aria-label="Next"
                    th:onclick="'paging(' + ${pageNumber + pageLine >= totalPages ? totalPages - 1 : pageNumber + pageLine} + ')'">
                <span>&raquo;</span>
                <span class="sr-only">10 Next</span>
            </button>
        </li>
    </ul>
</div>

<a href="/products/manage/register">상품 등록</a>

<script th:inline="javascript">
    const baseUrl = '/products/manage?';

    const paging = (pageNumber) => {
        const urlParams = getUrlParams();
        if (pageNumber === undefined || pageNumber === null) {
            pageNumber = 0;
        }
        urlParams.set("page", pageNumber);
        refreshUrl(urlParams);
    }

    const search = () => {
        const keyword = document.querySelector('#keyword').value;
        const urlParams = getUrlParams();
        setSearchParam(urlParams, 'keyword', keyword);
        setSearchParam(urlParams, 'page', 0);
        refreshUrl(urlParams);
    }

    function setSearchParam(urlParams, param, value) {
        if (param !== undefined) {
            urlParams.set(param, value);
        }
    }

    const getUrlParams = () => {
        const url = new URL(window.location.href);
        return url.searchParams;
    }

    const refreshUrl = (urlParams) => {
        location.href = baseUrl + urlParams.toString();
    }

    const deleteHandle = (productId) => {
        console.log(`remove ${productId}.`);
        const form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", "/products/manage/" + productId);

        const inputElement = document.createElement("input");
        inputElement.setAttribute("type", "hidden");
        inputElement.setAttribute("name", "_method");
        inputElement.setAttribute("value", "delete");
        form.appendChild(inputElement);
        document.body.appendChild(form);
        form.submit();
    }

    const urlParams = getUrlParams();
    document.querySelector('#keyword').value = urlParams.get('keyword');
</script>
</body>
</html>